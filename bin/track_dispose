#!/usr/bin/env ruby
begin
  start = Time.now
  filename = "dispose_log.txt"
  File.open(filename, "w") {}
  command = "bin/shoes #{ARGV.first} > #{filename}"
  puts "Logging SWT objects disposed in finalizers to #{filename}"
  puts "Running `#{command}`...quit to see results"
  system command
ensure
  finish = Time.now
  duration = finish - start
  lines = `wc -l #{filename}`.chomp.to_i
  rate = lines / duration
  format = "%H:%M:%S"

  footer = Proc.new do |out|
    out.puts "\n"
    out.puts "Started at #{start.strftime(format)}"
    out.puts "Finished at #{finish.strftime(format)}"
    out.puts "Elapsed: #{duration} sec"
    out.puts "\n"
    out.puts "#{lines} objects disposed in finalizers (#{rate} disposals/sec)"
  end

  File.open(filename, "a") do |f|
    footer.call(f)
  end

  puts footer.call(STDOUT)
end
